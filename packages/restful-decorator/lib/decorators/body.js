"use strict";
/**
 * Created by user on 2019/6/8.
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const config_1 = __importDefault(require("./config"));
const reflect_metadata_util_1 = require("reflect-metadata-util");
const cloneDeep_1 = __importDefault(require("lodash/cloneDeep"));
exports.SymParamMap = Symbol('ParamMap');
function BodyParams(value) {
    return config_1.default('params', value, true);
}
exports.BodyParams = BodyParams;
function BodyData(value) {
    return config_1.default('data', value, true);
}
exports.BodyData = BodyData;
function _paramBuilder(paramName) {
    return function (key, defaultValue) {
        return function (target, propertyKey, parameterIndex) {
            const paramObj = {
                key,
                parameterIndex,
                defaultValue,
            };
            const arr = reflect_metadata_util_1.getMemberMetadata(paramName, target, propertyKey) || [];
            arr.push(paramObj);
            reflect_metadata_util_1.setMemberMetadata(paramName, arr, target, propertyKey);
        };
    };
}
function ParamBody(defaultValue) {
    return function (target, propertyKey, parameterIndex) {
        const paramObj = {
            key: "Body" /* PARAM_BODY */,
            parameterIndex,
            defaultValue,
        };
        reflect_metadata_util_1.setMemberMetadata("Body" /* PARAM_BODY */, paramObj, target, propertyKey);
    };
}
exports.ParamBody = ParamBody;
exports.ParamPath = _paramBuilder("Path" /* PARAM_PATH */);
exports.ParamQuery = _paramBuilder("Query" /* PARAM_QUERY */);
exports.ParamData = _paramBuilder("Data" /* PARAM_DATA */);
exports.ParamHeader = _paramBuilder("Header" /* PARAM_HEADER */);
function getParamMetadata(target, propertyKey) {
    let maps = reflect_metadata_util_1.getMemberMetadata(exports.SymParamMap, target, propertyKey);
    return {
        ["Path" /* PARAM_PATH */]: reflect_metadata_util_1.getMemberMetadata("Path" /* PARAM_PATH */, target, propertyKey),
        ["Query" /* PARAM_QUERY */]: reflect_metadata_util_1.getMemberMetadata("Query" /* PARAM_QUERY */, target, propertyKey),
        ["Data" /* PARAM_DATA */]: reflect_metadata_util_1.getMemberMetadata("Data" /* PARAM_DATA */, target, propertyKey),
        ["Header" /* PARAM_HEADER */]: reflect_metadata_util_1.getMemberMetadata("Header" /* PARAM_HEADER */, target, propertyKey),
        ["Body" /* PARAM_BODY */]: reflect_metadata_util_1.getMemberMetadata("Body" /* PARAM_BODY */, target, propertyKey),
        ...maps,
    };
}
exports.getParamMetadata = getParamMetadata;
function HandleParamMetadata(fn) {
    return function (target, propertyKey, descriptor) {
        const oldMethod = descriptor.value;
        descriptor.value = function (...argv) {
            let ret;
            let paramMetadata;
            paramMetadata = _habdleParamInfo({
                //target,
                //propertyKey,
                //thisArgv: this,
                argv,
                paramMetadata: getParamMetadata(this, propertyKey),
            });
            //console.dir(argv);
            argv = _ParamInfoToArgv(paramMetadata, argv);
            //console.dir(argv);
            ret = fn({
                target,
                propertyKey,
                thisArgv: this,
                argv,
                paramMetadata,
            });
            if (ret.paramMetadata == null) {
                ret.paramMetadata = paramMetadata;
            }
            if (ret.argv != null) {
                argv = ret.argv;
            }
            else {
                ret.argv = argv;
            }
            return oldMethod.apply(this, argv);
        };
    };
}
exports.HandleParamMetadata = HandleParamMetadata;
function _habdleParamInfo(info) {
    const { argv } = info;
    const data = cloneDeep_1.default(info.paramMetadata);
    return Object.keys(data)
        .reduce((ret, key) => {
        if (data[key] == null || (Array.isArray(data[key]) && !data[key].length)) {
            return ret;
        }
        if (key === "Body" /* PARAM_BODY */) {
            const row = data[key];
            const value = argv[row.parameterIndex];
            ret[key] = {
                ...data[key],
                value,
            };
        }
        else {
            const arr = data[key];
            ret[key] = arr.map((row) => {
                const value = argv[row.parameterIndex];
                return {
                    ...row,
                    value,
                };
            });
        }
        return ret;
    }, {});
}
exports._habdleParamInfo = _habdleParamInfo;
function _ParamInfoToArgv(data, argv) {
    return Object.keys(data)
        .reduce(function (argv, key) {
        let arr;
        if (key === "Body" /* PARAM_BODY */) {
            arr = [data[key]];
        }
        else {
            arr = data[key];
        }
        arr.forEach((row) => {
            argv[row.parameterIndex] = row.value == null ? row.defaultValue : row.value;
        });
        return argv;
    }, argv.slice());
}
exports._ParamInfoToArgv = _ParamInfoToArgv;
function _paramBuilderMap(paramName) {
    return function (defaultValue) {
        return function (target, propertyKey, parameterIndex) {
            const paramObj = {
                key: null,
                parameterIndex,
                defaultValue,
            };
            const data = reflect_metadata_util_1.getMemberMetadata(exports.SymParamMap, target, propertyKey) || {};
            data[paramName] = data[paramName] || [];
            data[paramName].push(paramObj);
            reflect_metadata_util_1.setMemberMetadata(exports.SymParamMap, data, target, propertyKey);
        };
    };
}
exports.ParamMapPath = _paramBuilderMap("Map_Path" /* PARAM_MAP_PATH */);
exports.ParamMapQuery = _paramBuilderMap("Map_Query" /* PARAM_MAP_QUERY */);
exports.ParamMapData = _paramBuilderMap("Map_Data" /* PARAM_MAP_DATA */);
exports.ParamMapHeader = _paramBuilderMap("Map_Header" /* PARAM_MAP_HEADER */);
exports.ParamMapAuto = _paramBuilderMap("Map_Auto" /* PARAM_MAP_AUTO */);
exports.ParamMapBody = _paramBuilderMap("Map_Body" /* PARAM_MAP_BODY */);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9keS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJvZHkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOzs7OztBQUVILHNEQUFxQztBQUVyQyxpRUFBZ0g7QUFDaEgsaUVBQXlDO0FBRTVCLFFBQUEsV0FBVyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQVU5QyxTQUFnQixVQUFVLENBQVUsS0FBUTtJQUUzQyxPQUFPLGdCQUFhLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztBQUM3QyxDQUFDO0FBSEQsZ0NBR0M7QUFFRCxTQUFnQixRQUFRLENBQVUsS0FBUTtJQUV6QyxPQUFPLGdCQUFhLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztBQUMzQyxDQUFDO0FBSEQsNEJBR0M7QUFtQkQsU0FBUyxhQUFhLENBQUMsU0FBbUY7SUFFekcsT0FBTyxVQUE4QyxHQUFNLEVBQUUsWUFBZ0I7UUFFNUUsT0FBTyxVQUFVLE1BQWMsRUFBRSxXQUF5QixFQUFFLGNBQXNCO1lBRWpGLE1BQU0sUUFBUSxHQUFxQjtnQkFDbEMsR0FBRztnQkFDSCxjQUFjO2dCQUNkLFlBQVk7YUFDWixDQUFDO1lBRUYsTUFBTSxHQUFHLEdBQWlCLHlDQUFpQixDQUFDLFNBQVMsRUFBRSxNQUFNLEVBQUUsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDO1lBRWxGLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFbkIseUNBQWlCLENBQUMsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDeEQsQ0FBQyxDQUFDO0lBQ0gsQ0FBQyxDQUFDO0FBQ0gsQ0FBQztBQUVELFNBQWdCLFNBQVMsQ0FBVSxZQUFnQjtJQUVsRCxPQUFPLFVBQVUsTUFBYyxFQUFFLFdBQXlCLEVBQUUsY0FBc0I7UUFFakYsTUFBTSxRQUFRLEdBQXFEO1lBQ2xFLEdBQUcseUJB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QUFDO0FBRXpFLFFBQUEsWUFBWSxHQUFHLGdCQUFnQixpQ0FBdUMsQ0FBQztBQUV2RSxRQUFBLGNBQWMsR0FBRyxnQkFBZ0IscUNBQXlDLENBQUM7QUFFM0UsUUFBQSxZQUFZLEdBQUcsZ0JBQWdCLGlDQUF1QyxDQUFDO0FBRXZFLFFBQUEsWUFBWSxHQUFHLGdCQUFnQixpQ0FBdUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMTkvNi84LlxuICovXG5cbmltcG9ydCBSZXF1ZXN0Q29uZmlnIGZyb20gJy4vY29uZmlnJztcbmltcG9ydCB7IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEgfSBmcm9tICcuL2h0dHAnO1xuaW1wb3J0IHsgZ2V0TWVtYmVyTWV0YWRhdGEsIElQYXJhbWV0ZXJEZWNvcmF0b3IsIElQcm9wZXJ0eUtleSwgc2V0TWVtYmVyTWV0YWRhdGEgfSBmcm9tICdyZWZsZWN0LW1ldGFkYXRhLXV0aWwnO1xuaW1wb3J0IGNsb25lRGVlcCBmcm9tICdsb2Rhc2gvY2xvbmVEZWVwJztcblxuZXhwb3J0IGNvbnN0IFN5bVBhcmFtTWFwID0gU3ltYm9sKCdQYXJhbU1hcCcpO1xuXG5leHBvcnQgaW50ZXJmYWNlIElQYXJhbWV0ZXI8SyA9IHN0cmluZywgViA9IGFueT5cbntcblx0a2V5OiBLO1xuXHRwYXJhbWV0ZXJJbmRleDogbnVtYmVyO1xuXHRkZWZhdWx0VmFsdWU/OiBWXG5cdHZhbHVlPzogViB8IHVua25vd25cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIEJvZHlQYXJhbXM8VCA9IGFueT4odmFsdWU6IFQpXG57XG5cdHJldHVybiBSZXF1ZXN0Q29uZmlnKCdwYXJhbXMnLCB2YWx1ZSwgdHJ1ZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBCb2R5RGF0YTxUID0gYW55Pih2YWx1ZTogVClcbntcblx0cmV0dXJuIFJlcXVlc3RDb25maWcoJ2RhdGEnLCB2YWx1ZSwgdHJ1ZSk7XG59XG5cbmV4cG9ydCB0eXBlIElFbnVtUmVzdENsaWVudE1ldGFkYXRhUGFyYW0gPVxuXHRFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX1BBVEhcblx0fCBFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX1FVRVJZXG5cdHwgRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9EQVRBXG5cdHwgRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9CT0RZXG5cdHwgRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9IRUFERVJcblx0O1xuXG5leHBvcnQgdHlwZSBJRW51bVJlc3RDbGllbnRNZXRhZGF0YVBhcmFtTWFwID1cblx0RW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9NQVBfUEFUSFxuXHR8IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fTUFQX1FVRVJZXG5cdHwgRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9NQVBfREFUQVxuXHR8IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fTUFQX0JPRFlcblx0fCBFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX01BUF9IRUFERVJcblx0fCBFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX01BUF9BVVRPXG5cdDtcblxuZnVuY3Rpb24gX3BhcmFtQnVpbGRlcihwYXJhbU5hbWU6IEV4Y2x1ZGU8SUVudW1SZXN0Q2xpZW50TWV0YWRhdGFQYXJhbSwgRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9CT0RZPilcbntcblx0cmV0dXJuIGZ1bmN0aW9uIDxLIGV4dGVuZHMgc3RyaW5nID0gc3RyaW5nLCBWID0gYW55PihrZXk6IEssIGRlZmF1bHRWYWx1ZT86IFYpOiBJUGFyYW1ldGVyRGVjb3JhdG9yXG5cdHtcblx0XHRyZXR1cm4gZnVuY3Rpb24gKHRhcmdldDogb2JqZWN0LCBwcm9wZXJ0eUtleTogSVByb3BlcnR5S2V5LCBwYXJhbWV0ZXJJbmRleDogbnVtYmVyKVxuXHRcdHtcblx0XHRcdGNvbnN0IHBhcmFtT2JqOiBJUGFyYW1ldGVyPEssIFY+ID0ge1xuXHRcdFx0XHRrZXksXG5cdFx0XHRcdHBhcmFtZXRlckluZGV4LFxuXHRcdFx0XHRkZWZhdWx0VmFsdWUsXG5cdFx0XHR9O1xuXG5cdFx0XHRjb25zdCBhcnI6IElQYXJhbWV0ZXJbXSA9IGdldE1lbWJlck1ldGFkYXRhKHBhcmFtTmFtZSwgdGFyZ2V0LCBwcm9wZXJ0eUtleSkgfHwgW107XG5cblx0XHRcdGFyci5wdXNoKHBhcmFtT2JqKTtcblxuXHRcdFx0c2V0TWVtYmVyTWV0YWRhdGEocGFyYW1OYW1lLCBhcnIsIHRhcmdldCwgcHJvcGVydHlLZXkpO1xuXHRcdH07XG5cdH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBQYXJhbUJvZHk8ViA9IGFueT4oZGVmYXVsdFZhbHVlPzogVilcbntcblx0cmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQ6IG9iamVjdCwgcHJvcGVydHlLZXk6IElQcm9wZXJ0eUtleSwgcGFyYW1ldGVySW5kZXg6IG51bWJlcilcblx0e1xuXHRcdGNvbnN0IHBhcmFtT2JqOiBJUGFyYW1ldGVyPEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fQk9EWSwgVj4gPSB7XG5cdFx0XHRrZXk6IEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fQk9EWSxcblx0XHRcdHBhcmFtZXRlckluZGV4LFxuXHRcdFx0ZGVmYXVsdFZhbHVlLFxuXHRcdH07XG5cblx0XHRzZXRNZW1iZXJNZXRhZGF0YShFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0JPRFksIHBhcmFtT2JqLCB0YXJnZXQsIHByb3BlcnR5S2V5KTtcblx0fTtcbn1cblxuZXhwb3J0IGNvbnN0IFBhcmFtUGF0aCA9IF9wYXJhbUJ1aWxkZXIoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9QQVRIKTtcblxuZXhwb3J0IGNvbnN0IFBhcmFtUXVlcnkgPSBfcGFyYW1CdWlsZGVyKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fUVVFUlkpO1xuXG5leHBvcnQgY29uc3QgUGFyYW1EYXRhID0gX3BhcmFtQnVpbGRlcihFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0RBVEEpO1xuXG5leHBvcnQgY29uc3QgUGFyYW1IZWFkZXIgPSBfcGFyYW1CdWlsZGVyKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fSEVBREVSKTtcblxuLy9leHBvcnQgY29uc3QgUGFyYW1Cb2R5ID0gX3BhcmFtQnVpbGRlcihFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0JPRFkpKCdCb2R5Jyk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVBhcmFtTWV0YWRhdGEgZXh0ZW5kcyBJUGFyYW1NZXRhZGF0YTJcbntcblx0W0VudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fUEFUSF06IElQYXJhbWV0ZXJbXSxcblx0W0VudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fUVVFUlldOiBJUGFyYW1ldGVyW10sXG5cdFtFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0RBVEFdOiBJUGFyYW1ldGVyW10sXG5cdFtFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0hFQURFUl06IElQYXJhbWV0ZXJbXSxcblx0W0VudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fQk9EWV06IElQYXJhbWV0ZXIsXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVBhcmFtTWV0YWRhdGEyXG57XG5cdFtFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX01BUF9QQVRIXTogSVBhcmFtZXRlcltdLFxuXHRbRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9NQVBfUVVFUlldOiBJUGFyYW1ldGVyW10sXG5cdFtFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX01BUF9EQVRBXTogSVBhcmFtZXRlcltdLFxuXHRbRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9NQVBfSEVBREVSXTogSVBhcmFtZXRlcltdLFxuXHRbRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9NQVBfQk9EWV06IElQYXJhbWV0ZXJbXSxcblx0W0VudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fTUFQX0FVVE9dOiBJUGFyYW1ldGVyW10sXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRQYXJhbU1ldGFkYXRhKHRhcmdldDogb2JqZWN0LCBwcm9wZXJ0eUtleTogSVByb3BlcnR5S2V5KTogSVBhcmFtTWV0YWRhdGFcbntcblx0bGV0IG1hcHMgPSBnZXRNZW1iZXJNZXRhZGF0YShTeW1QYXJhbU1hcCwgdGFyZ2V0LCBwcm9wZXJ0eUtleSkgYXMgSVBhcmFtTWV0YWRhdGEyO1xuXG5cdHJldHVybiB7XG5cdFx0W0VudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fUEFUSF06IGdldE1lbWJlck1ldGFkYXRhKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fUEFUSCwgdGFyZ2V0LCBwcm9wZXJ0eUtleSksXG5cdFx0W0VudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fUVVFUlldOiBnZXRNZW1iZXJNZXRhZGF0YShFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX1FVRVJZLCB0YXJnZXQsIHByb3BlcnR5S2V5KSxcblx0XHRbRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9EQVRBXTogZ2V0TWVtYmVyTWV0YWRhdGEoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9EQVRBLCB0YXJnZXQsIHByb3BlcnR5S2V5KSxcblx0XHRbRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9IRUFERVJdOiBnZXRNZW1iZXJNZXRhZGF0YShFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0hFQURFUiwgdGFyZ2V0LCBwcm9wZXJ0eUtleSksXG5cdFx0W0VudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fQk9EWV06IGdldE1lbWJlck1ldGFkYXRhKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fQk9EWSwgdGFyZ2V0LCBwcm9wZXJ0eUtleSksXG5cblx0XHQuLi5tYXBzLFxuXHR9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gSGFuZGxlUGFyYW1NZXRhZGF0YTxUIGV4dGVuZHMgYW55PihmbjogKChpbmZvOiB7XG5cdHRhcmdldDogVCxcblx0cHJvcGVydHlLZXk6IElQcm9wZXJ0eUtleSxcblx0dGhpc0FyZ3Y6IFRoaXNUeXBlPFQ+LFxuXHRhcmd2OiBhbnlbXSxcblx0cGFyYW1NZXRhZGF0YTogSVBhcmFtTWV0YWRhdGEsXG59KSA9PiB7XG5cdHBhcmFtTWV0YWRhdGE6IElQYXJhbU1ldGFkYXRhLFxuXHRhcmd2OiBhbnlbXSxcbn0pKVxue1xuXHRyZXR1cm4gZnVuY3Rpb24gKHRhcmdldDogYW55LCBwcm9wZXJ0eUtleTogSVByb3BlcnR5S2V5LCBkZXNjcmlwdG9yOiBUeXBlZFByb3BlcnR5RGVzY3JpcHRvcjxGdW5jdGlvbj4pXG5cdHtcblx0XHRjb25zdCBvbGRNZXRob2QgPSBkZXNjcmlwdG9yLnZhbHVlO1xuXG5cdFx0ZGVzY3JpcHRvci52YWx1ZSA9IGZ1bmN0aW9uICguLi5hcmd2OiBhbnlbXSlcblx0XHR7XG5cdFx0XHRsZXQgcmV0OiB7XG5cdFx0XHRcdHBhcmFtTWV0YWRhdGE6IElQYXJhbU1ldGFkYXRhLFxuXHRcdFx0XHRhcmd2OiBhbnlbXSxcblx0XHRcdH07XG5cblx0XHRcdGxldCBwYXJhbU1ldGFkYXRhOiBJUGFyYW1NZXRhZGF0YTtcblxuXHRcdFx0cGFyYW1NZXRhZGF0YSA9IF9oYWJkbGVQYXJhbUluZm8oe1xuXHRcdFx0XHQvL3RhcmdldCxcblx0XHRcdFx0Ly9wcm9wZXJ0eUtleSxcblx0XHRcdFx0Ly90aGlzQXJndjogdGhpcyxcblx0XHRcdFx0YXJndixcblx0XHRcdFx0cGFyYW1NZXRhZGF0YTogZ2V0UGFyYW1NZXRhZGF0YSh0aGlzLCBwcm9wZXJ0eUtleSksXG5cdFx0XHR9KTtcblxuXHRcdFx0Ly9jb25zb2xlLmRpcihhcmd2KTtcblxuXHRcdFx0YXJndiA9IF9QYXJhbUluZm9Ub0FyZ3YocGFyYW1NZXRhZGF0YSwgYXJndik7XG5cblx0XHRcdC8vY29uc29sZS5kaXIoYXJndik7XG5cblx0XHRcdHJldCA9IGZuKHtcblx0XHRcdFx0dGFyZ2V0LFxuXHRcdFx0XHRwcm9wZXJ0eUtleSxcblx0XHRcdFx0dGhpc0FyZ3Y6IHRoaXMsXG5cdFx0XHRcdGFyZ3YsXG5cdFx0XHRcdHBhcmFtTWV0YWRhdGEsXG5cdFx0XHR9KTtcblxuXHRcdFx0aWYgKHJldC5wYXJhbU1ldGFkYXRhID09IG51bGwpXG5cdFx0XHR7XG5cdFx0XHRcdHJldC5wYXJhbU1ldGFkYXRhID0gcGFyYW1NZXRhZGF0YTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKHJldC5hcmd2ICE9IG51bGwpXG5cdFx0XHR7XG5cdFx0XHRcdGFyZ3YgPSByZXQuYXJndjtcblx0XHRcdH1cblx0XHRcdGVsc2Vcblx0XHRcdHtcblx0XHRcdFx0cmV0LmFyZ3YgPSBhcmd2O1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gb2xkTWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3YpO1xuXHRcdH07XG5cdH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBfaGFiZGxlUGFyYW1JbmZvPFQ+KGluZm86IHtcblx0Ly90YXJnZXQ6IFQsXG5cdC8vcHJvcGVydHlLZXk6IElQcm9wZXJ0eUtleSxcblx0Ly90aGlzQXJndjogVGhpc1R5cGU8VD4sXG5cdGFyZ3Y6IGFueVtdLFxuXHRwYXJhbU1ldGFkYXRhOiBJUGFyYW1NZXRhZGF0YSxcbn0pXG57XG5cdGNvbnN0IHsgYXJndiB9ID0gaW5mbztcblx0Y29uc3QgZGF0YSA9IGNsb25lRGVlcChpbmZvLnBhcmFtTWV0YWRhdGEpIGFzIElQYXJhbU1ldGFkYXRhO1xuXG5cdHJldHVybiBPYmplY3Qua2V5cyhkYXRhKVxuXHRcdC5yZWR1Y2UoKHJldDogSVBhcmFtTWV0YWRhdGEsIGtleToga2V5b2YgSVBhcmFtTWV0YWRhdGEpID0+XG5cdFx0e1xuXHRcdFx0aWYgKGRhdGFba2V5XSA9PSBudWxsIHx8IChBcnJheS5pc0FycmF5KGRhdGFba2V5XSkgJiYgIShkYXRhW2tleV0gYXMgSVBhcmFtZXRlcltdKS5sZW5ndGgpKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gcmV0O1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoa2V5ID09PSBFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0JPRFkpXG5cdFx0XHR7XG5cdFx0XHRcdGNvbnN0IHJvdyA9IGRhdGFba2V5XTtcblx0XHRcdFx0Y29uc3QgdmFsdWUgPSBhcmd2W3Jvdy5wYXJhbWV0ZXJJbmRleF07XG5cblx0XHRcdFx0cmV0W2tleV0gPSB7XG5cdFx0XHRcdFx0Li4uZGF0YVtrZXldLFxuXHRcdFx0XHRcdHZhbHVlLFxuXHRcdFx0XHR9O1xuXHRcdFx0fVxuXHRcdFx0ZWxzZVxuXHRcdFx0e1xuXHRcdFx0XHRjb25zdCBhcnIgPSBkYXRhW2tleV0gYXMgSVBhcmFtZXRlcltdO1xuXG5cdFx0XHRcdHJldFtrZXldID0gYXJyLm1hcCgocm93KSA9PlxuXHRcdFx0XHR7XG5cblx0XHRcdFx0XHRjb25zdCB2YWx1ZSA9IGFyZ3Zbcm93LnBhcmFtZXRlckluZGV4XTtcblxuXHRcdFx0XHRcdHJldHVybiB7XG5cdFx0XHRcdFx0XHQuLi5yb3csXG5cdFx0XHRcdFx0XHR2YWx1ZSxcblx0XHRcdFx0XHR9IGFzIGFueSBhcyBJUGFyYW1ldGVyO1xuXHRcdFx0XHR9KSBhcyBJUGFyYW1ldGVyW107XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiByZXQ7XG5cdFx0fSwge30gYXMgSVBhcmFtTWV0YWRhdGEpIGFzIElQYXJhbU1ldGFkYXRhXG5cdFx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gX1BhcmFtSW5mb1RvQXJndjxUIGV4dGVuZHMgYW55W10+KGRhdGE6IElQYXJhbU1ldGFkYXRhLCBhcmd2OiBUKVxue1xuXHRyZXR1cm4gT2JqZWN0LmtleXMoZGF0YSlcblx0XHQucmVkdWNlKGZ1bmN0aW9uIChhcmd2LCBrZXk6IGtleW9mIElQYXJhbU1ldGFkYXRhKVxuXHRcdHtcblxuXHRcdFx0bGV0IGFycjogSVBhcmFtZXRlcltdO1xuXG5cdFx0XHRpZiAoa2V5ID09PSBFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX0JPRFkpXG5cdFx0XHR7XG5cdFx0XHRcdGFyciA9IFtkYXRhW2tleV1dO1xuXHRcdFx0fVxuXHRcdFx0ZWxzZVxuXHRcdFx0e1xuXHRcdFx0XHRhcnIgPSBkYXRhW2tleV0gYXMgSVBhcmFtZXRlcltdO1xuXHRcdFx0fVxuXG5cdFx0XHRhcnIuZm9yRWFjaCgocm93KSA9PlxuXHRcdFx0e1xuXHRcdFx0XHRhcmd2W3Jvdy5wYXJhbWV0ZXJJbmRleF0gPSByb3cudmFsdWUgPT0gbnVsbCA/IHJvdy5kZWZhdWx0VmFsdWUgOiByb3cudmFsdWU7XG5cdFx0XHR9KTtcblxuXHRcdFx0cmV0dXJuIGFyZ3Y7XG5cdFx0fSwgYXJndi5zbGljZSgpKVxuXHRcdDtcbn1cblxuZnVuY3Rpb24gX3BhcmFtQnVpbGRlck1hcChwYXJhbU5hbWU6IElFbnVtUmVzdENsaWVudE1ldGFkYXRhUGFyYW1NYXApXG57XG5cdHJldHVybiBmdW5jdGlvbiA8SyBleHRlbmRzIHN0cmluZyA9IHN0cmluZywgViA9IGFueT4oZGVmYXVsdFZhbHVlPzogVik6IElQYXJhbWV0ZXJEZWNvcmF0b3Jcblx0e1xuXHRcdHJldHVybiBmdW5jdGlvbiAodGFyZ2V0OiBvYmplY3QsIHByb3BlcnR5S2V5OiBJUHJvcGVydHlLZXksIHBhcmFtZXRlckluZGV4OiBudW1iZXIpXG5cdFx0e1xuXHRcdFx0Y29uc3QgcGFyYW1PYmo6IElQYXJhbWV0ZXI8SywgVj4gPSB7XG5cdFx0XHRcdGtleTogbnVsbCxcblx0XHRcdFx0cGFyYW1ldGVySW5kZXgsXG5cdFx0XHRcdGRlZmF1bHRWYWx1ZSxcblx0XHRcdH07XG5cblx0XHRcdGNvbnN0IGRhdGEgPSBnZXRNZW1iZXJNZXRhZGF0YShTeW1QYXJhbU1hcCwgdGFyZ2V0LCBwcm9wZXJ0eUtleSkgfHwge307XG5cblx0XHRcdGRhdGFbcGFyYW1OYW1lXSA9IGRhdGFbcGFyYW1OYW1lXSB8fCBbXTtcblxuXHRcdFx0ZGF0YVtwYXJhbU5hbWVdLnB1c2gocGFyYW1PYmopO1xuXG5cdFx0XHRzZXRNZW1iZXJNZXRhZGF0YShTeW1QYXJhbU1hcCwgZGF0YSwgdGFyZ2V0LCBwcm9wZXJ0eUtleSk7XG5cdFx0fTtcblx0fTtcbn1cblxuZXhwb3J0IGNvbnN0IFBhcmFtTWFwUGF0aCA9IF9wYXJhbUJ1aWxkZXJNYXAoRW51bVJlc3RDbGllbnRNZXRhZGF0YS5QQVJBTV9NQVBfUEFUSCk7XG5cbmV4cG9ydCBjb25zdCBQYXJhbU1hcFF1ZXJ5ID0gX3BhcmFtQnVpbGRlck1hcChFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX01BUF9RVUVSWSk7XG5cbmV4cG9ydCBjb25zdCBQYXJhbU1hcERhdGEgPSBfcGFyYW1CdWlsZGVyTWFwKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fTUFQX0RBVEEpO1xuXG5leHBvcnQgY29uc3QgUGFyYW1NYXBIZWFkZXIgPSBfcGFyYW1CdWlsZGVyTWFwKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fTUFQX0hFQURFUik7XG5cbmV4cG9ydCBjb25zdCBQYXJhbU1hcEF1dG8gPSBfcGFyYW1CdWlsZGVyTWFwKEVudW1SZXN0Q2xpZW50TWV0YWRhdGEuUEFSQU1fTUFQX0FVVE8pO1xuXG5leHBvcnQgY29uc3QgUGFyYW1NYXBCb2R5ID0gX3BhcmFtQnVpbGRlck1hcChFbnVtUmVzdENsaWVudE1ldGFkYXRhLlBBUkFNX01BUF9CT0RZKTtcbiJdfQ==